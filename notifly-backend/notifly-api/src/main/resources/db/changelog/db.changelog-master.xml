<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- Create TENANTS table -->
    <changeSet id="001-create-tenants" author="notifly">
        <createTable tableName="tenants">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- Create NOTIFICATION_REQUESTS table with multi-tenancy -->
    <changeSet id="002-create-notification-requests" author="notifly">
        <createTable tableName="notification_requests">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="request_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="idempotency_key" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payload_hash" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="recipient_address" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Unique constraints for idempotency -->
        <addUniqueConstraint tableName="notification_requests" 
                            columnNames="tenant_id,request_id"
                            constraintName="uk_notification_requests_tenant_request_id"/>
        <addUniqueConstraint tableName="notification_requests"
                            columnNames="tenant_id,idempotency_key"
                            constraintName="uk_notification_requests_tenant_idempotency_key"/>

        <!-- Indexes for tenant filtering -->
        <createIndex tableName="notification_requests" indexName="idx_tenant_request">
            <column name="tenant_id"/>
            <column name="request_id"/>
        </createIndex>
        <createIndex tableName="notification_requests" indexName="idx_tenant_created">
            <column name="tenant_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>

        <!-- Foreign key -->
        <addForeignKeyConstraint baseTableName="notification_requests"
                                baseColumnNames="tenant_id"
                                referencedTableName="tenants"
                                referencedColumnNames="id"
                                constraintName="fk_notification_requests_tenant_id"
                                onDelete="CASCADE"/>
    </changeSet>

    <!-- Create NOTIFICATION_OUTBOX table (Transactional Outbox) -->
    <changeSet id="003-create-notification-outbox" author="notifly">
        <createTable tableName="notification_outbox">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="aggregate_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="event_payload" type="jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Index for polling pending events -->
        <createIndex tableName="notification_outbox" indexName="idx_outbox_status_created">
            <column name="status"/>
            <column name="created_at"/>
        </createIndex>
        <createIndex tableName="notification_outbox" indexName="idx_outbox_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <!-- Foreign key -->
        <addForeignKeyConstraint baseTableName="notification_outbox"
                                baseColumnNames="tenant_id"
                                referencedTableName="tenants"
                                referencedColumnNames="id"
                                constraintName="fk_notification_outbox_tenant_id"
                                onDelete="CASCADE"/>
    </changeSet>

    <!-- Create API_KEYS table -->
    <changeSet id="004-create-api-keys" author="notifly">
        <createTable tableName="api_keys">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="key_hash" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="key_prefix" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="display_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="revoked_at" type="timestamp with time zone"/>
        </createTable>

        <!-- Unique constraint -->
        <addUniqueConstraint tableName="api_keys"
                            columnNames="tenant_id,key_prefix"
                            constraintName="uk_api_keys_tenant_key_prefix"/>

        <!-- Indexes -->
        <createIndex tableName="api_keys" indexName="idx_api_key_tenant">
            <column name="tenant_id"/>
        </createIndex>
        <createIndex tableName="api_keys" indexName="idx_api_key_prefix">
            <column name="key_prefix"/>
        </createIndex>

        <!-- Foreign key -->
        <addForeignKeyConstraint baseTableName="api_keys"
                                baseColumnNames="tenant_id"
                                referencedTableName="tenants"
                                referencedColumnNames="id"
                                constraintName="fk_api_keys_tenant_id"
                                onDelete="CASCADE"/>
    </changeSet>

    <!-- Create RATE_LIMIT_CONFIG table -->
    <changeSet id="005-create-rate-limit-config" author="notifly">
        <createTable tableName="rate_limit_config">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="requests_per_minute" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="burst_limit" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Unique constraint -->
        <addUniqueConstraint tableName="rate_limit_config"
                            columnNames="tenant_id"
                            constraintName="uk_rate_limit_config_tenant_id"/>

        <!-- Foreign key -->
        <addForeignKeyConstraint baseTableName="rate_limit_config"
                                baseColumnNames="tenant_id"
                                referencedTableName="tenants"
                                referencedColumnNames="id"
                                constraintName="fk_rate_limit_config_tenant_id"
                                onDelete="CASCADE"/>
    </changeSet>

    <!-- Enable JSONB GIN index for payload search -->
    <changeSet id="006-create-jsonb-index" author="notifly">
        <sql>
            CREATE INDEX idx_notification_requests_payload_gin 
            ON notification_requests USING GIN (payload);
        </sql>
    </changeSet>

</databaseChangeLog>
