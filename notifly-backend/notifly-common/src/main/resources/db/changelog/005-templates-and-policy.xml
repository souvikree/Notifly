<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- Notification Templates -->
    <changeSet id="011-create-notification-templates" author="notifly">
        <sql>
            CREATE TABLE notification_templates (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                name VARCHAR(255) NOT NULL,
                version INT NOT NULL DEFAULT 1,
                channel VARCHAR(50) NOT NULL
                    CHECK (channel IN ('EMAIL', 'SMS', 'PUSH', 'WEBHOOK')),
                subject VARCHAR(500),
                content TEXT NOT NULL,
                variables JSONB,
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                created_by UUID REFERENCES admin_users(id) ON DELETE SET NULL,
                CONSTRAINT unique_template UNIQUE (tenant_id, name, version)
            );
        </sql>
    </changeSet>

    <!-- Event Channel Policy -->
    <changeSet id="012-create-event-channel-policy" author="notifly">
        <sql>
            CREATE TABLE event_channel_policy (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                event_type VARCHAR(100) NOT NULL,
                fallback_order JSONB NOT NULL,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_policy UNIQUE (tenant_id, event_type)
            );
        </sql>
    </changeSet>

    <!-- Retry Policy -->
    <changeSet id="013-create-retry-policy" author="notifly">
        <sql>
            CREATE TABLE retry_policy (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                event_type VARCHAR(100) NOT NULL,
                max_attempts INT NOT NULL DEFAULT 5,
                initial_delay_ms BIGINT NOT NULL DEFAULT 1000,
                max_delay_ms BIGINT NOT NULL DEFAULT 60000,
                backoff_multiplier NUMERIC(4,2) NOT NULL DEFAULT 1.5,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_retry_policy UNIQUE (tenant_id, event_type)
            );
        </sql>
    </changeSet>

    <!-- Rate Limit Config -->
    <changeSet id="014-create-rate-limit-config" author="notifly">
        <sql>
            CREATE TABLE rate_limit_config (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL UNIQUE REFERENCES tenants(id) ON DELETE CASCADE,
                requests_per_minute INT NOT NULL DEFAULT 1000,
                requests_per_hour INT NOT NULL DEFAULT 50000,
                burst_limit INT NOT NULL DEFAULT 5000,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
        </sql>
    </changeSet>

    <!-- User Channel Preferences -->
    <changeSet id="015-create-user-channel-preferences" author="notifly">
        <sql>
            CREATE TABLE user_channel_preferences (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                user_id VARCHAR(255) NOT NULL,
                channel VARCHAR(50) NOT NULL
                    CHECK (channel IN ('EMAIL', 'SMS', 'PUSH', 'WEBHOOK')),
                is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_preference UNIQUE (tenant_id, user_id, channel)
            );
        </sql>
    </changeSet>

    <!-- Admin Audit Logs -->
    <changeSet id="016-create-admin-audit-logs" author="notifly">
        <sql>
            CREATE TABLE admin_audit_logs (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                user_id UUID REFERENCES admin_users(id) ON DELETE SET NULL,
                action VARCHAR(100) NOT NULL,
                resource_type VARCHAR(100),
                resource_id VARCHAR(255),
                changes JSONB,
                ip_address VARCHAR(45),
                user_agent TEXT,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
        </sql>
    </changeSet>

</databaseChangeLog>