<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="
                   http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="002-create-tenants" author="notifly">
        <sql>
            CREATE TABLE tenants (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                name VARCHAR(255) NOT NULL UNIQUE,
                slug VARCHAR(100) NOT NULL UNIQUE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
        </sql>
    </changeSet>

    <changeSet id="003-create-api-keys" author="notifly">
        <sql>
            CREATE TABLE api_keys (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                key_hash VARCHAR(255) NOT NULL,
                key_prefix VARCHAR(50) NOT NULL,
                display_name VARCHAR(255),
                role VARCHAR(50) NOT NULL DEFAULT 'SERVICE'
                    CHECK (role IN ('ADMIN', 'SERVICE')),
                last_used_at TIMESTAMP WITH TIME ZONE,
                revoked BOOLEAN DEFAULT FALSE,
                revoked_at TIMESTAMP WITH TIME ZONE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_api_key UNIQUE(tenant_id, key_prefix)
            );
        </sql>
    </changeSet>

    <changeSet id="004-create-admin-users" author="notifly">
        <sql>
            CREATE TABLE admin_users (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                email VARCHAR(255) NOT NULL,
                password_hash VARCHAR(255),
                first_name VARCHAR(100),
                last_name VARCHAR(100),
                auth_provider VARCHAR(20) NOT NULL DEFAULT 'LOCAL'
                    CHECK (auth_provider IN ('LOCAL', 'GOOGLE', 'LINKED')),
                google_id VARCHAR(255) UNIQUE,
                avatar_url TEXT,
                role VARCHAR(50) NOT NULL DEFAULT 'ADMIN'
                    CHECK (role IN ('ADMIN', 'EDITOR', 'VIEWER')),
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_admin_email UNIQUE(tenant_id, email)
            );
        </sql>
    </changeSet>

</databaseChangeLog>