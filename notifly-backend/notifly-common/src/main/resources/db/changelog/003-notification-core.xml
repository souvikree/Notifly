<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- Notification Requests -->
    <changeSet id="005-create-notification-requests" author="notifly">
        <sql>
            CREATE TABLE notification_requests (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                request_id UUID NOT NULL,
                idempotency_key VARCHAR(255),
                event_type VARCHAR(100) NOT NULL,
                payload JSONB NOT NULL,
                payload_hash VARCHAR(255),
                status VARCHAR(50) DEFAULT 'PENDING'
                    CHECK (status IN ('PENDING', 'ACCEPTED', 'PROCESSING', 'SENT', 'FAILED')),
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT unique_request UNIQUE (tenant_id, request_id)
            );
        </sql>
    </changeSet>

    <!-- Partial Unique Index for Idempotency -->
    <changeSet id="006-idempotency-partial-index" author="notifly">
        <sql>
            CREATE UNIQUE INDEX unique_idempotency
            ON notification_requests (tenant_id, idempotency_key)
            WHERE idempotency_key IS NOT NULL;
        </sql>
    </changeSet>

    <!-- Transactional Outbox -->
    <changeSet id="007-create-notification-outbox" author="notifly">
        <sql>
            CREATE TABLE notification_outbox (
                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
                aggregate_id UUID NOT NULL,
                event_payload JSONB NOT NULL,
                status VARCHAR(50) NOT NULL DEFAULT 'PENDING'
                    CHECK (status IN ('PENDING', 'SENT', 'FAILED')),
                retry_count INT DEFAULT 0,
                last_error TEXT,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                sent_at TIMESTAMP WITH TIME ZONE
            );
        </sql>
    </changeSet>

</databaseChangeLog>