<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="017-create-indexes" author="notifly">
        <sql>

            -- API Keys
            CREATE INDEX idx_api_keys_tenant        ON api_keys(tenant_id);
            CREATE INDEX idx_api_keys_prefix        ON api_keys(key_prefix);
            CREATE INDEX idx_api_keys_tenant_prefix ON api_keys(tenant_id, key_prefix);

            -- Admin Users
            CREATE INDEX idx_admin_users_tenant       ON admin_users(tenant_id);
            CREATE INDEX idx_admin_users_email        ON admin_users(email);
            CREATE INDEX idx_admin_users_tenant_email ON admin_users(tenant_id, email);
            CREATE INDEX idx_admin_users_google_id    ON admin_users(google_id) WHERE google_id IS NOT NULL;

            -- Notification Requests
            CREATE INDEX idx_notification_requests_tenant       ON notification_requests(tenant_id);
            CREATE INDEX idx_notification_requests_request_id   ON notification_requests(request_id);
            CREATE INDEX idx_notification_requests_tenant_reqid ON notification_requests(tenant_id, request_id);
            CREATE INDEX idx_notification_requests_created      ON notification_requests(created_at DESC);
            CREATE INDEX idx_notification_requests_status       ON notification_requests(status);
            CREATE INDEX idx_notification_requests_payload      ON notification_requests USING GIN(payload);

            -- Outbox
            CREATE INDEX idx_notification_outbox_status        ON notification_outbox(status);
            CREATE INDEX idx_notification_outbox_tenant_status ON notification_outbox(tenant_id, status);
            CREATE INDEX idx_notification_outbox_pending       ON notification_outbox(created_at)
                WHERE status = 'PENDING';

            -- Notification Logs
            CREATE INDEX idx_notification_logs_tenant       ON notification_logs(tenant_id);
            CREATE INDEX idx_notification_logs_request_id   ON notification_logs(request_id);
            CREATE INDEX idx_notification_logs_tenant_reqid ON notification_logs(tenant_id, request_id);
            CREATE INDEX idx_notification_logs_channel      ON notification_logs(channel);
            CREATE INDEX idx_notification_logs_status       ON notification_logs(status);
            CREATE INDEX idx_notification_logs_created      ON notification_logs(created_at DESC);
            CREATE INDEX idx_notification_logs_composite
                ON notification_logs(tenant_id, request_id, channel, retry_attempt);

            -- Retry Attempts
            CREATE INDEX idx_retry_attempts_tenant
                ON retry_attempts(tenant_id);
            CREATE INDEX idx_retry_attempts_next_retry
                ON retry_attempts(next_retry_at)
                WHERE next_retry_at IS NOT NULL;

            -- DLQ
            CREATE INDEX idx_failed_notifications_tenant
                ON failed_notifications(tenant_id);
            CREATE INDEX idx_failed_notifications_created
                ON failed_notifications(created_at DESC);
            CREATE INDEX idx_failed_notifications_channel
                ON failed_notifications(channel);

            -- Templates
            CREATE INDEX idx_notification_templates_tenant
                ON notification_templates(tenant_id);
            CREATE INDEX idx_notification_templates_name
                ON notification_templates(name);
            CREATE INDEX idx_notification_templates_active
                ON notification_templates(is_active);

            -- Policies
            CREATE INDEX idx_event_channel_policy_tenant
                ON event_channel_policy(tenant_id);
            CREATE INDEX idx_retry_policy_tenant
                ON retry_policy(tenant_id);

            -- Preferences
            CREATE INDEX idx_user_channel_preferences_tenant
                ON user_channel_preferences(tenant_id);
            CREATE INDEX idx_user_channel_preferences_user_id
                ON user_channel_preferences(user_id);

            -- Audit
            CREATE INDEX idx_admin_audit_logs_tenant
                ON admin_audit_logs(tenant_id);
            CREATE INDEX idx_admin_audit_logs_created
                ON admin_audit_logs(created_at DESC);
            CREATE INDEX idx_admin_audit_logs_action
                ON admin_audit_logs(action);

        </sql>
    </changeSet>

</databaseChangeLog>